# Claude Code Archive Protection Configuration

This directory contains hooks and configuration to protect the mailbox archive from accidental or unintended modifications.

## Protected Folders

The following folders are **read-only** and protected from all modification attempts:

- **`eml/`** - Canonical EML archive (original source of truth from Microsoft 365)
- **`status/`** - SQLite database containing sync state and metadata
- **`transformed/`** - Generated derived outputs (Markdown, HTML, attachments)

## Why These Folders Are Protected

These folders are managed entirely by `m365-mail-mirror` tool commands:

- **`eml/`** is populated exclusively by the `sync` command from Microsoft Graph API
- **`status/.sync.db`** is updated during sync to track message state and transformation metadata
- **`transformed/`** is generated by the `transform` command from EML source files

**Manual modifications to these folders will**:
1. Break sync operations (tool won't recognize state correctly)
2. Corrupt the archive (lose message metadata or cause transformation failures)
3. Create inconsistencies between the database and actual files
4. Make future syncs or transformations unpredictable

## Configuration

### hooks.json

Defines the protection rules and behavior:

- **readOnlyPaths**: List of folder prefixes that cannot be modified
- **beforeEdit hook**: Blocks any attempts to edit files in protected folders
- **beforeWrite hook**: Blocks any attempts to write to protected folders
- **validationRules**: Pattern-based rules that flag forbidden modifications

### Permitted Operations

You **can**:
- ✅ Read files in any folder (for analysis, research, queries)
- ✅ Run `m365-mail-mirror sync` to download/update messages
- ✅ Run `m365-mail-mirror transform` to regenerate outputs
- ✅ Query the database with `m365-mail-mirror query-sql`
- ✅ Create files outside protected folders (e.g., notes, analysis)

You **cannot**:
- ❌ Edit or delete files in `eml/`, `status/`, or `transformed/`
- ❌ Manually modify `.sync.db`
- ❌ Create new files within these protected folders
- ❌ Rename or move files within these folders

## What To Do Instead

If you need to modify email content or regenerate outputs:

```bash
# Regenerate Markdown/HTML/attachments from EML source
m365-mail-mirror transform

# Sync new messages from Microsoft 365
m365-mail-mirror sync

# Query the database safely
m365-mail-mirror query-sql "SELECT * FROM messages LIMIT 10"
```

## If You Accidentally Try to Modify

If you attempt to edit or write to a protected folder, Claude Code will refuse the operation with a message explaining why. This is intentional protection.

To fix issues with the archive:
1. Check the sync logs: `dotnet run -- status`
2. Verify the EML files are intact
3. Regenerate transformations: `dotnet run -- transform`
4. Re-sync if needed: `dotnet run -- sync`
